### Hent dataen ned til egen folder
rsync -a /willerslev/edna/bat_guano/gargina_dupka/* /willerslev/users-shared/science-snm-willerslev-vnt552/Bat/try1


### Tjek at de downloadede filer er intakt ved at bruge md5sum.
### md5sum skriver OK, hvis de har samme kode
md5sum --check md5sum.txt


### Trimming med fastP. Kommandoen sætter selv de rigtige filer ind på hver plads, da vi arbejder med paired end data.
for file in *_1.fq
  do
  f=$(echo $file | sed -E "s/\_.*//")
  echo ${f}_1.fq ${f}_2.fq
  /willerslev/edna/programmes/fastp/fastp -i ${f}_1.fq -I ${f}_2.fq -m --merged_out ${f}.fast-p.ppm.fq -V --detect_adapter_for_pe -D --dup_calc_accuracy 5 -g -x -q 30 -e 25 -l 30 -y -c -p -h ${f}.fastp.report.html -w 8
  done


### Vsearch
for file in *ppm.fq
do
vsearch --fastx_uniques ${file} --fastqout ${file}.vs.fq --minseqlength 30 --strand both
done


### sga Trimming. prøv med threshold=1,2,3 og 4. Tjek hvordan reads ser ud og vælg derefter en til at gå videre med.
for file in *vs.fq
do
sga preprocess --dust-threshold=1 -m 30 $file -o $file.sga1.fq
sga preprocess --dust-threshold=2 -m 30 $file -o $file.sga2.fq
sga preprocess --dust-threshold=3 -m 30 $file -o $file.sga3.fq
sga preprocess --dust-threshold=4 -m 30 $file -o $file.sga4.fq
done

### Map, merge,sort og align filerne med holi.sh
### problemer med holi. den ville kun mappe. Og ville have filerne sorteret inden merge.
#samtools merge --verbosity 5 -f GA-19.sga1.merged.sam.gz *.bam -@ 60


### Mapper sga4 filerne til de DB er er klar. Holi filen hedder mapping.sh
## da alle databaserne ikke var klar på samme tid, er data blevet mappet med brug af 3 forskellige holi.sh filer
### en for refseq, en for nt database og en sidste for mtDNA.

chmod 775 mapping.sh
./mapping.sh &> mapping.log.txt




##### Dernæst skal alt data merges og sorteres
## Merging all alignment files
for infile in $(pwd)/*.fq
do
bname=$(basename $infile)
echo $bname


## Filerne skal være sorteret før de kan merges
for bam in *.bam
do
samtools sort -@ 10 -m 10G -n $bam -o sort.$bam
done


samtools merge --verbosity 5 -o GA-19.fast-p.ppm.fq.vs.fq.sga4.fq.merged.sam.gz sort.GA-19.*.bam -@ 20


## Sorting the merged sam.gz file
echo Printing header
nice -n 5 time samtools view --threads 20  -H $bname.merged.sam.gz | gzip > $bname.merged.Header.sam.gz
echo Printing alignment
nice -n 5 time samtools view --threads 20 $bname.merged.sam.gz | gzip > $bname.merged.alignment.sam.gz
echo Sorting alignment file
time /willerslev/software/gz-sort/gz-sort -S 20G -P 10 $bname.merged.alignment.sam.gz $bname.merged.alignment.sort.sam.gz
echo Merging Header and sorted alignment
time zcat $bname.merged.Header.sam.gz $bname.merged.alignment.sort.sam.gz | samtools view -h -o $bname.merged.sort.sam.gz
rm $bname.merged.Header.sam.gz $bname.merged.alignment.sam.gz $bname.merged.alignment.sort.sam.gz

nice -n 5 time samtools view --threads 20  -H  GA-Cex.fast-p.ppm.fq.vs.fq.sga4.fq.merged.sam.gz | gzip > GA-Cex.fast-p.ppm.fq.vs.fq.sga4.fq.merged.Header.sam.gz
nice -n 5 time samtools view --threads 20 GA-Cex.fast-p.ppm.fq.vs.fq.sga4.fq.merged.sam.gz | gzip > GA-Cex.fast-p.ppm.fq.vs.fq.sga4.fq.merged.alignment.sam.gz
time /willerslev/software/gz-sort/gz-sort -S 20G -P 10 GA-Cex.fast-p.ppm.fq.vs.fq.sga4.fq.merged.alignment.sam.gz GA-Cex.fast-p.ppm.fq.vs.fq.sga4.fq.merged.alignment.sort.sam.gz
time zcat GA-Cex.fast-p.ppm.fq.vs.fq.sga4.fq.merged.Header.sam.gz GA-Cex.fast-p.ppm.fq.vs.fq.sga4.fq.merged.alignment.sort.sam.gz | samtools view -h -o GA-Cex.fast-p.ppm.fq.vs.fq.sga4.fq.merged.sort.sam.gz
rm GA-Cex.fast-p.ppm.fq.vs.fq.sga4.fq.merged.Header.sam.gz GA-Cex.fast-p.ppm.fq.vs.fq.sga4.fq.merged.alignment.sam.gz GA-Cex.fast-p.ppm.fq.vs.fq.sga4.fq.merged.alignment.sort.sam.gz


## Running metaDamage
## data skal være en directory med sam.gz files. names, nodes and acc2tax er stier til de filer der bliver dannet under ngsLCA
## /science/willerslev/edna/ncbi_taxonomy_01Oct2022

tax=/science/willerslev/edna/ncbi_taxonomy_01Oct2022
nam=$tax/names.dmp
nod=$tax/nodes.dmp
ac2tax=$tax/combined_accession2taxid_20221112.gz


#conda activate metaDMG
metaDMG config bat_data/*.sam.gz -m /willerslev/edna/programmes/metaDMG-cpp/metaDMG-cpp --names $nam --nodes $nod --acc2tax $ac2tax
metaDMG compute config.yaml
metaDMG convert config.yaml -a --output ./data/results/${sname}.results.csv.gz


conda install gsl=2.7
metaDMG config bat_data/holi_results/*61.fast-p.ppm.fq.vs.fq.sga4.fq.merged.sort.sam.gz \
    --names /science/willerslev/edna/ncbi_taxonomy_01Oct2022/names.dmp \
    --nodes /science/willerslev/edna/ncbi_taxonomy_01Oct2022/nodes.dmp \
    --acc2tax /science/willerslev/edna/ncbi_taxonomy_01Oct2022/combined_accession2taxid_20221112.gz \
    --metaDMG-cpp /willerslev/edna/programmes/metaDMG-cpp/metaDMG-cpp \
    --min-similarity-score 0.90 \
    --config-file config_0.9_1.yaml \
    --output-dir bat_data/results_0.9


metaDMG compute config_0.9_1.yaml
metaDMG convert config_0.9_1.yaml --output ./bat_data/results_0.9/results/results_09.csv.gz

metaDMG compute config_GarginaDupka.yaml
metaDMG convert config_GarginaDupka.yaml --output ./bat_data/results/results/results.csv.gz
metaDMG dashboard
